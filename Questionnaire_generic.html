<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Vehicle Info Confirmation (Debug)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f2f4f7; color: #333; }
    form { background: #ffeb7c; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
    h2 { margin-bottom: 24px; color: #0053a0; font-size: 1.5rem; text-align: center; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: bold; margin-bottom: 6px; }
    input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color .2s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #007bff; }
    .follow-up { margin-top: 8px; padding-left: 16px; border-left: 3px solid #007bff; display: none; }
    .radio-group, .checkbox-group { display: flex; flex-wrap: wrap; gap: 12px; }
    .radio-group label, .checkbox-group label { font-weight: normal; }
    .radio-group input, .checkbox-group input { margin-right: 6px; }
    .range-group input { width: 100%; }
    button { display: block; width: 100%; padding: 12px; background-color: #fafafa; color: #000; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; transition: background-color .2s; }
    button:hover { background-color: #ffffff; }
    .emoji-display { text-align: center; font-size: 2rem; margin-top: 8px; }
    /* Hide default messenger launcher */
    .sc-launcher { display: none !important; }
  </style>

  <!-- Sunshine Conversations / Zendesk Webview SDK -->
  <script src="https://adam-s-cxt.github.io/sunshine-conversations-web/smooch.5.7.4.min.js"></script>

  <!-- Debug instrumentation: wrap SDK methods, patch fetch, listen to events -->
  <script>
    // Wrap key Smooch methods to log arguments and results
    (function(){
      if (!window.Smooch) return;
      function wrap(fnName) {
        const orig = Smooch[fnName];
        if (typeof orig !== 'function') return;
        Smooch[fnName] = function(...args) {
          console.group(`[Smooch] ${fnName}`);
          console.log('‚Üí arguments:', args);
          const result = orig.apply(this, args);
          if (result && typeof result.then === 'function') {
            result.then(res => {
              console.log('‚úì resolved:', res);
              console.groupEnd();
              return res;
            }).catch(err => {
              console.error('‚úó rejected:', err);
              console.groupEnd();
              throw err;
            });
          } else {
            console.log('‚úì returned:', result);
            console.groupEnd();
          }
          return result;
        };
      }
      ['init','loadConversation','sendMessage','getConversationById'].forEach(wrap);

      // Patch fetch to log network calls to conversations endpoints
      const origFetch = window.fetch;
      window.fetch = function(resource, options) {
        if (typeof resource === 'string' && resource.includes('/conversations/')) {
          console.group('[fetch]'); console.log('‚Üí URL:', resource); console.log('‚Üí options:', options);
        }
        return origFetch(resource, options).then(response => {
          if (response.url && response.url.includes('/conversations/')) {
            console.log('‚Üê status:', response.status, response.statusText);
            response.clone().text().then(body => console.log('‚Üê body:', body));
            console.groupEnd();
          }
          return response;
        });
      };

      // Listen for all Smooch events
      Smooch.on('*', (eventName, payload) => console.log(`[event:${eventName}]`, payload));
    })();
  </script>

</head>
<body>

  <form id="vehicleForm">
    <h2>Vehicle Info Confirmation</h2>
    <!-- (form fields unchanged) -->
    <div class="form-group">
      <label>Is your vehicle taxed and not currently SORN/off the road?</label>
      <select name="tax_status" onchange="toggleFollowUp(this,'taxFollowUp')">
        <option value="">Select an option</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
      </select>
      <div id="taxFollowUp" class="follow-up">
        <label>Provide more details:</label>
        <textarea name="tax_details" rows="3"></textarea>
      </div>
    </div>
    <!-- rest of form groups... -->
    <!-- Satisfaction slider -->
    <div class="form-group range-group">
      <label for="satisfaction">How satisfied? (1-5)</label>
      <input type="range" id="satisfaction" name="satisfaction" min="1" max="5" step="1" value="3">
      <div id="satisfactionEmoji" class="emoji-display">üòê</div>
    </div>
    <button type="submit">Submit</button>
  </form>

  <script>
    // Core SDK init (embedded to avoid UI)
    const INTEGRATION_ID  = "64f5a35e7e9cf2bd7bc34a37";
    const CONVERSATION_ID = "681ca86ef34de2d9eacfd30c";
    let smoochReady = false;

    window.addEventListener('load', () => {
      Smooch.init({ integrationId: INTEGRATION_ID, region: 'eu-1', embedded: true })
        .then(() => Smooch.loadConversation(CONVERSATION_ID))
        .then(() => { smoochReady = true; })
        .catch(err => console.error('init or loadConversation failed:', err));
    });

    // Follow-up toggles and emoji map
    function toggleFollowUp(sel, id) {
      document.getElementById(id).style.display = ['no','incorrect','has_mods'].includes(sel.value)?'block':'none';
    }
    const emojiMap = {1:'üòû',2:'üòï',3:'üòê',4:'üôÇ',5:'üòÉ'};
    document.getElementById('satisfaction').addEventListener('input', e => {
      document.getElementById('satisfactionEmoji').textContent = emojiMap[e.target.value];
    });

    // Form submission with post-send inspection
    document.getElementById('vehicleForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this), data = {};
      formData.forEach((v,k) => { data[k] = data[k]?[].concat(data[k],v):v });
      const lines = ['üìã Vehicle Info:'];
      // build summary as before...
      if (data.satisfaction) lines.push(`‚Äì Satisfaction: ${data.satisfaction}/5`);
      const summary = lines.join('\n');

      if (smoochReady) {
        try {
          const sendRes = await Smooch.sendMessage({ type:'text', text: summary }, CONVERSATION_ID);
          console.log('[sendMessage result]', sendRes);
          const conv = await Smooch.getConversationById(CONVERSATION_ID);
          console.log('‚û§ current conversation.messages:', conv.messages);
        } catch(err) {
          console.error('Failed to send message via Smooch:', err);
        }
      }

      // close and thank-you UI
      if (window.closeExtension) window.closeExtension();
      else window.parent.postMessage({ type:'form:submitted', data, close:true }, '*');
      this.innerHTML = `<h2>Thank you!</h2><p>Your info is submitted.</p>`;
    });
  </script>

</body>
</html>
